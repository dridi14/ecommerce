- name: Ensure Magento root exists
  file:
    path: "{{ magento_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
    recurse: yes

- name: Install Composer
  get_url:
    url: https://getcomposer.org/download/latest-stable/composer.phar
    dest: /usr/local/bin/composer
    mode: "0755"

- name: Create Magento project (idempotent)
  command: >
    composer create-project
    --repository=https://mirror.mage-os.org/
    magento/project-community-edition={{ magento_version }}
    {{ magento_root }}
  args:
    creates: "{{ magento_root }}/composer.lock"

- name: Deploy env.php
  template:
    src: env.php.j2
    dest: "{{ magento_root }}/app/etc/env.php"
    owner: www-data
    group: www-data
    mode: "0644"

- name: Set Production Mode
  command: bin/magento deploy:mode:set production --skip-compilation
  args:
    chdir: "{{ magento_root }}"

- name: Compile DI
  command: bin/magento setup:di:compile
  args:
    chdir: "{{ magento_root }}"
  become_user: www-data

- name: Deploy Static Content
  command: bin/magento setup:static-content:deploy -f
  args:
    chdir: "{{ magento_root }}"
  become_user: www-data

- name: Install Cron
  command: bin/magento cron:install
  args:
    chdir: "{{ magento_root }}"
  become_user: www-data

- name: Set filesystem permissions
  file:
    path: "{{ item }}"
    owner: www-data
    group: www-data
    recurse: yes
  loop:
    - "{{ magento_root }}/var"
    - "{{ magento_root }}/pub"
    - "{{ magento_root }}/generated"
