- name: Ensure parent directory for Magento exists
  file:
    path: "{{ magento_root | dirname }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

- name: Install Composer
  get_url:
    url: https://getcomposer.org/download/latest-stable/composer.phar
    dest: /usr/local/bin/composer
    mode: "0755"

- name: Ensure Composer home directory
  file:
    path: /root/.composer
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Disable Composer audit security block (optional but required for Magento 2.4.6)
  command: composer config --global audit.block-insecure false
  environment:
    COMPOSER_ALLOW_SUPERUSER: "1"
    COMPOSER_HOME: "/root/.composer"
    COMPOSER_BLOCK_INSECURE_PACKAGES: "0"
  args:
    creates: /root/.composer/config.json

- name: Configure Composer auth for Magento Marketplace
  copy:
    dest: /root/.composer/auth.json
    owner: root
    group: root
    mode: "0600"
    content: |
      {
        "http-basic": {
          "repo.magento.com": {
            "username": "{{ magento_public_key }}",
            "password": "{{ magento_private_key }}"
          }
        }
      }
  no_log: true

- name: Create Magento project (idempotent)
  command: >
    /usr/local/bin/composer create-project
    --no-interaction
    --no-progress
    --prefer-dist
    --repository-url=https://repo.magento.com/
    magento/project-community-edition={{ magento_version }}
    {{ magento_root }}
  environment:
    COMPOSER_ALLOW_SUPERUSER: "1"
    COMPOSER_HOME: "/root/.composer"
    COMPOSER_BLOCK_INSECURE_PACKAGES: "0"
  args:
    creates: "{{ magento_root }}/composer.lock"
  register: magento_create
  retries: 3
  delay: 20
  until: magento_create.rc == 0

- name: Verify Magento CLI exists
  stat:
    path: "{{ magento_root }}/bin/magento"
  register: magento_bin

- name: Fail if Magento CLI is missing
  fail:
    msg: "Magento CLI not found at {{ magento_root }}/bin/magento (composer install incomplete)."
  when: not magento_bin.stat.exists

- name: Install Magento if not configured
  command: >
    {{ magento_root }}/bin/magento setup:install
    --base-url={{ magento_base_url }}
    --db-host={{ db_host }}
    --db-name={{ db_name }}
    --db-user={{ db_username }}
    --db-password={{ db_password }}
    --backend-frontname={{ magento_backend_frontname }}
    --admin-firstname={{ magento_admin_firstname }}
    --admin-lastname={{ magento_admin_lastname }}
    --admin-email={{ magento_admin_email }}
    --admin-user={{ magento_admin_username }}
    --admin-password={{ magento_admin_password }}
    --language=en_US
    --currency=USD
    --timezone=UTC
    --use-rewrites=1
    --search-engine={{ magento_search_engine }}
    --opensearch-host={{ magento_opensearch_host }}
    --opensearch-port={{ magento_opensearch_port }}
  args:
    creates: "{{ magento_root }}/app/etc/env.php"
  no_log: true

- name: Set filesystem permissions
  file:
    path: "{{ item }}"
    owner: www-data
    group: www-data
    recurse: yes
  loop:
    - "{{ magento_root }}"
    - "{{ magento_root }}/var"
    - "{{ magento_root }}/pub"
    - "{{ magento_root }}/app/etc"
